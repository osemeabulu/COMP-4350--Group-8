{% extends "layout.html" %}

{% block content %}

    <div class="hero-unit">
        <h2>{{ course.cid }} - {{ course.cname }}</h2>
        <br />
        <p>{{ course.cdesc }}</p>
        <br />

        <a href="#submitReview" role="button" class="btn" data-toggle="modal">Submit a Review</a>

        <div id="submitReview" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                <h3 id="modalLabel">Submitting a Review for {{ course.cname }}</h3>
            </div>

            <div class="modal-body">
            <form id="review">
				<fieldset>
					<div>
					    <p>Rating</p>
                        <select id="score">
                            <option>1</option>
                            <option>2</option>
                            <option>3</option>
                            <option>4</option>
                            <option>5</option>
                        </select>
					</div>
					<div>
						<p>Description</p>
						<textarea class="input-xlarge" data-jsonify-name="rdesc" id="description" rows="7"></textarea>
					</div>
                    <button type="submit" class="btn">Submit</button>
				</fieldset>
			</form>
            </div>

            <div class="modal-footer">
                <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
            </div>
        </div>

        <p>
			<!--
			<a class="btn btn-primary btn-small" href="" id="submit">
				submit
			</a>
			-->
			
			<!--
            <button class="btn btn-success btn-mini"><i class="icon-white icon-thumbs-up"></i></button>
            <button class="btn btn-danger btn-mini"><i class="icon-white icon-thumbs-down"></i></button>
            -->
        </p>
    </div>

    <div class="hero-unit">
    
    <h2>Reviews:</h2>
    <div id="results">
    </div>

    </div>

    
    
	<script>
		$(window).load(function() {
			$.getJSON($SCRIPT_ROOT + "{{ url_for('reviews.query_by_course') }}",
			{
				key: "{{ course.cid }}"
			},
			function(data)
			{
			    var content = '';

			    content += '<table class="table table-bordered"><thead><tr><th>User</th><th>Score</th><th>Review</th><th>Like/Dislike</th></tr></thead><tbody>'; 

				$.each(data.reviews, function(i, item)
				{
					content += '<tr><td>N/A</td><td>'+ item.rscr + '</td><td>' + item.rdesc + '</td><td>  <button class="btn btn-success btn-mini" id="upvote' + item.id +'"><i class="icon-white icon-thumbs-up"></i></button>\n' +
								'<button class="btn btn-danger btn-mini" id="downvote' + item.id +'"><i class="icon-white icon-thumbs-down"></i></button></td></tr>';
				});

                content+='</tbody></table>';

				$('#results').empty().append(content);
			});
			
			return false;
		});

		$('#review').submit(function () {
		    var formObject = new Object();

		    formObject.cid = "{{ course.cid }}"
		    formObject.rscr = $('select[id="score"]').val()
		    formObject.rdesc = $('textarea[id="description"]').val()
		    formObject.rvote = 0

		    var result;
		    $.ajax({
		        type: "POST",
		        contentType: "application/json; charset=utf-8",
		        url: "{{ url_for('reviews.submit_review') }}",
		        data: JSON.stringify(formObject),
		        success: function (data) {
		            location.reload();
		        },
		        dataType: "json"
		    });

		    $('#submitReview').modal('hide')

		    return false;
		});
	</script>
{% endblock content %}
