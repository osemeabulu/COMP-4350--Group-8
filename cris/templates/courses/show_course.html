{% extends "layout.html" %}

{% block content %}

    <div class="hero-unit">
        <h2>{{ course.cid }} - {{ course.cname }}</h2>
        <br />
        <p>{{ course.cdesc }}</p>
        <br />
        <p>
			<form id="review">
				<fieldset>
					<div>
						<label class="control-label" for="cid">Course ID</label>
						<input type="text" data-jsonify-name="cid" class="input-small" id="cid" value={{ course.cid }}></input>
					</div>
					<div>
						<label class="control-label" for="score">Score out of 5</label>
						<input type="text" data-jsonify-name="rscr" class="input-small" id="score"></input>
					</div>
					<div>
						<label class="control-label" for="description">Description</label>
						<textarea class="input-xlarge" data-jsonify-name="rdesc" id="description" rows="3"></textarea>
					</div>
					<div>
						<!--button type="submit" class="btn" data-toggle="modal" data-target="#reviewModal" data-show="false">submit</button-->
						<button type="submit" class="btn">submit</button-->
					</div>
				</fieldset>
			</form>
			
			<!--
			<a class="btn btn-primary btn-small" href="" id="submit">
				submit
			</a>
			-->
			
			<!--
            <button class="btn btn-success btn-mini"><i class="icon-white icon-thumbs-up"></i></button>
            <button class="btn btn-danger btn-mini"><i class="icon-white icon-thumbs-down"></i></button>
            -->
        </p>
    </div>
    
    <div class="hero-unit" id="results">
    
    </div>
    <div id="reviewContainer">
    	<div id="reviewModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    		<div class="modal-header">
    			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
				<h3 id="myModalLabel"></h3>
			</div>
			<div class="modal-body">
				<h3>Review Posted.</h3>
			</div>
			<div class="modal-footer">
				<button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
			</div>
		</div>
	<!--button class="btn btn-primary">Save changes</button></div></div-->
    </div>
    
	<script>

		$(window).load(function() {
			$.getJSON($SCRIPT_ROOT + "{{ url_for('reviews.query_by_course') }}",
			{
				key: "{{ course.cid }}"
			},
			function(data)
			{
				var content = '';
				var nil = null;
				content += '<h2>Reviews</h2>'
				$.each(data.reviews, function(i, item)
				{
					content += '<p>' + item.rdesc  + ' Score: ' + item.rscr + '</p> <div id="numup' + i + '"><p>' + item.upvote + ' likes <button class="btn btn-success btn-mini" onclick="vote_reviews(' + i + ', ' + item.upvote + ', ' + nil + ', \'' + item.cid + '\')"><i class="icon-white icon-thumbs-up"></i></button></p></div>' +
								'<div id="numdown' + i + '"><p>' + item.downvote + ' dislikes <button class="btn btn-danger btn-mini" onclick="vote_reviews(' + i + ', ' + nil + ', ' + item.downvote + ', \'' + item.cid + '\')"><i class="icon-white icon-thumbs-down"></i></button></p></div>'
								
					
				});
				
				$('#results').empty().append(content);
			});
			
			return false;
		});
    
		$('#review').submit(function() {
			var formObject = new Object();
			
			formObject.cid = $('input[id="cid"]').val();
			formObject.rscr = $('input[id="score"]').val();
			formObject.rdesc = $('textarea[id="description"]').val();
			formObject.rvote = 0;
			formObject.upvote = 0;
			formObject.downvote = 0;
			
			var result;
			
			$.ajax({
				type: "POST",
				contentType: "application/json; charset=utf-8",
				url: "{{ url_for('reviews.submit_review') }}",
				data: JSON.stringify(formObject),
				success: function (data) {
					//result = '<p>' + data.rdesc  + ' [ ' + data.rscr + ' ]</p>  <p id="numup">(' + data.upvote + ')</p><button id="upbtn" class="btn btn-success btn-mini"><i class="icon-white icon-thumbs-up"></i></button>' +
								//'<p id="numdown">(' + data.downvote + ')</p><button id="downbtn" class="btn btn-danger btn-mini"><i class="icon-white icon-thumbs-down"></i></button>\n';
					$('#results').append(result);
					$('#reviewModal').modal('show');
					$('#reviewModal').on('hidden', function(){
						location.reload();
						
					});					
					
				},
				dataType:"json"
			});
			
			return false;
		});
		
		function vote_reviews(i, upvote, downvote, cid)
		{
			if(upvote != null){
				upvote++;
			}
			else{
				downvote++;
			}
					
			$.getJSON($SCRIPT_ROOT + "{{ url_for('reviews.calculate_vote')}}",
			{
				uvote: upvote,
				dvote: downvote,
				course: cid,
				key: i
				
			}, function(data) {
        		if(upvote != null){
        			$('#numup'+ i).html('<div id="numup"><p>' + data.result + ' likes <button class="btn btn-success btn-mini"><i class="icon-white icon-thumbs-up"></i></button></p></div>')
        		}
        		else{
        			$('#numdown' + i).html('<div id="numdown"><p>' + data.result + ' dislikes <button class="btn btn-danger btn-mini"><i class="icon-white icon-thumbs-down"></i></i></button></p></div>')
        		}
        	});
			
			return false;
			
		}

	</script>
{% endblock content %}
